---
title: "Gun Violence and Covariates"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(plotly)
library(tidyverse)

# fixed width dataframe

merged_firearm_mortality <-
	read_csv("./shiny_dataset/merged_firearm_mortality.csv") %>%
	select(state_abb, year, crude_rate, deaths, population, law_strength) %>%
	rename(state = state_abb) %>% 
	unite(col = state_year, state, year, sep = "_")

gun_violence <- read_csv("./shiny_dataset/gun_violence_tidy.csv") %>% 
	sample_n(size = 25000)

gun_violence_merged <- read_csv("./shiny_dataset/gun_violence_tidy.csv") %>%
	group_by(state, year) %>%
	summarize(total_killed = n(), total_injured = n()) %>% 
	unite(col = state_year, state, year, sep = "_")

unempl <- read_csv("./shiny_dataset/unempl.csv") %>% 
	unite(col = state_year, state, year, sep = "_")

merged_data <- full_join(x = gun_violence_merged, y = unempl, by = "state_year")
merged_data <- full_join(x = merged_data, y = merged_firearm_mortality, by = "state_year")
merged_data_wide <- merged_data %>% 
	separate(col = state_year, into = c("state", "year"), sep = "_")

merged_data <- merged_data_wide %>% 
	gather(key = type_variable, value = value, total_killed:law_strength) %>% 
	mutate(year = as.numeric(year)) %>% 
	arrange(year)

year <- c(2000:2016)
type_variable <- (merged_data %>% distinct(type_variable) %>% pull())[3:6]

firearm_mortality = read_csv("./devon_data/cdc_firearm_mortality_data.csv", na = "Unreliable") %>% 
	janitor::clean_names() %>% 
	select(-ten_year_age_groups_code, -injury_mechanism_all_other_leading_causes_code, -race_code, death_cause = injury_mechanism_all_other_leading_causes) %>% 
	mutate(ten_year_age_groups = factor(ten_year_age_groups, levels = c("1-4 years", "5-14 years", "15-24 years", "25-34 years", "35-44 years", "45-54 years", "55-64 years", "65-74 years", "75-84 years", "85+ years")))


```

Page 1
===================================== 

Column {.tabset}
-----------------------------------------------------------------------


```{r}
# navbarPage("shiny_states",
					 # tabPanel("US MAP",
fluidRow(column(6,
					 				 sidebarPanel(width = 200,
					 				 	selectInput("year",
					 				 							label = h3("Choose year"),
					 				 							choices = as.list(year),
					 				 							selected = 2015))),
					 		
					 # tabPanel("Regression",
				 				 column(6,
					 sidebarPanel(width = 12,
					 				 selectInput("variable_type",
					 				 						 label = h3("Choose variable"),
					 				 						 choices = type_variable,
					 				 						 selected = "law_strength"))))




renderPlotly({
	geo1 <- list(
	scope = "usa",
	projection = list(type = "state"),
	showlakes = TRUE,
	lakecolor = toRGB("white")
	)
	
	merged_data %>% 
	filter(type_variable == input$variable_type, year == input$year) %>% 
	plot_geo(locationmode = "USA-states") %>% 
	add_trace(
		z = ~value,
		locations = ~state,
		color = ~value,
		colors = "Reds"
		) %>%
	layout(
		geo = geo1
	)
})







```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### US MAP

```{r}



renderPlotly({
	geo1 <- list(
	scope = "usa",
	projection = list(type = "state"),
	showlakes = TRUE,
	lakecolor = toRGB("white")
	)
	
	merged_data %>% 
	filter(type_variable == input$variable_type, year == input$year) %>% 
	plot_geo(locationmode = "USA-states") %>% 
	add_trace(
		z = ~value,
		locations = ~state,
		color = ~value,
		colors = "Reds"
		) %>%
	layout(
		geo = geo1
	)
})



# rsconnect::deployApp("./shiny_states.Rmd")

```

Page 2
===================================== 

Column {.tabset}
-----------------------------------------------------------------------

### Sex, Age Group

```{r}




renderPlotly({
  age_race <- firearm_mortality %>% 
  filter(year == input$year) %>% 
	group_by(ten_year_age_groups, race) %>%
	summarize(n_deaths = sum(deaths),
						n_population = sum(population)) %>% 
	mutate(crude_rate = (n_deaths/n_population) * 100000) %>% 
  spread(key = race, value = crude_rate) %>%
  janitor::clean_names() %>% 
  plot_ly(x = ~ten_year_age_groups,
  				y = ~white,
  				name = "White",
  				type = "bar") %>% 
  	add_trace(y = ~american_indian_or_alaska_native,
  						name = "American Indian or Alaska Native") %>% 
  	add_trace(y = ~asian_or_pacific_islander,
  						name = "Asian or Pacific Islander") %>% 
  	add_trace(y = ~american_indian_or_alaska_native,
  						name = "American Indian or Alaska Native") %>% 
  	layout(barmode = "stack")
  
# 	ggplot(aes(fill = race, x = ten_year_age_groups, y = crude_rate, color = race)) +
# 	geom_bar(stat = "identity") +
# 	theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
# 	labs(
#     title = "Crude Firearm Death Rate Across All States by Age Group and Race, 1999",
#     x = "Age Group",
#     y = "Crude Firearm Death Rate",
#     caption = "Data from the CDC Wonder Dataset")
#   
#   ggplotly(age_race)
})

```

### Description

Microarray data matrix for 80 experiments with Saccharomyces Cerevisiae
organism extracted from R's `biclust` package.

Sebastian Kaiser, Rodrigo Santamaria, Tatsiana Khamiakova, Martin Sill, Roberto
  Theron, Luis Quintales, Friedrich Leisch and Ewoud De Troyer. (2015). biclust:
  BiCluster Algorithms. R package version 1.2.0.
  http://CRAN.R-project.org/package=biclust